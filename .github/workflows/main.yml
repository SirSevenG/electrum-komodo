name: Komodo Electrum CI

on:
  pull_request:
    types: [opened, reopened]
  push:
    branches:
      - master
      - dev
    paths-ignore:
      - ./README.md
    tags-ignore:
      - '*.noci'

jobs:

  linux-ci:
    name: Linux
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Install deps (Linux)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get remove php7.1-fpm php7.2-fpm php7.3-fpm php7.4-fpm php7.3-common
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get upgrade -y
          sudo apt-get update
          sudo apt-get install -q \
                 python3 \
                 python3-dev \
                 python3-setuptools \
                 python3-pip \
                 python3-pyqt5 \
                 pyqt5-dev-tools \
                 python-requests \
                 gettext \
                 python3-setuptools \
                 protobuf-compiler \
                 libusb-1.0-0-dev \
                 libudev-dev -y
          python3 -m pip install setuptools wheel
          python3 -m pip install pytest
          python3 -m pip install .[full]

      - name: Build (Linux)
        run: |
          pyrcc5 icons.qrc -o gui/qt/icons_rc.py
          protoc --proto_path=lib/ --python_out=lib/ lib/paymentrequest.proto
          ./contrib/make_locale

      - name: Run Tests (Linux)
        run: |
          python3 -m pytest lib/tests/ -s -vv

  macos-ci:
    name: MacOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v1

      - name: Build (MacOS)
        run: |
          contrib/build-osx/before_install-osx.sh
          contrib/build-osx/build-gha.sh

      - name: Run Tests (MacOS)
        run: |
          python3 -m pip install --upgrade pip
          sudo python3 -m pip install .[full] --ignore-installed
          python3 -m pip install pytest
          python3 -m pytest lib/tests/ -s -vv
